# armory-terraform-bitbucket

Terraform scripts to deploy a **Bitbucket Server** intance into EKS and expose it through AWS ALB.

# Terraform Cloud

The remote state backend is configured to run over [armory-bitbucket](https://app.terraform.io/app/dou-armory/workspaces/armory-bitbucket) workspace in PS DOU Terraform Cloud (TFC) account.

The main `dockerhub_username` and `dockerhub_password` variables with sensitive data are already configured in current TFC [variables workspace](https://app.terraform.io/app/dou-armory/workspaces/armory-bitbucket/variables).

# GitHub Workflow

The GitHub repository has configured a workflow to execute a new `terraform plan` on each PR to `master` branch and validate mergeability; once the PR gets merged into `master` a `terraform apply` is auto-approved.

# Requirements

|Name      |Version     |
|----------|------------|
|terraform |>= v1.1.2   |
|aws       |~> 3.60.0   |
|kubernetes|>= 2.5.0    |

# Providers

|Name      |Version     |
|----------|------------|
|aws       |~> 3.60.0   |
|kubernetes|>= 2.5.0    |

# Resources

|Name|Type|
|-|-|
|[aws_route53_record.bitbucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record)|resource|
|[kubernetes_deployment.bitbucket](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/deployment)|resource|
|[kubernetes_ingress.bitbucket](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/ingress)|resource|
|[kubernetes_namespace.bitbucket](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/namespace)|resource|
|[kubernetes_persistent_volume_claim.bitbucket](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/persistent_volume_claim)|resource|
|[kubernetes_secret.dockerhub](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/secret)|resource|
|[kubernetes_service.bitbucket](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/service)|resource|
|[aws_acm_certificate.cert](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/acm_certificate)|data source|
|[aws_eks_cluster.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster)|data source|
|[aws_eks_cluster_auth.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster_auth)|data source|
|[aws_route53_zone.subdomain](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone)|data source|
|[terraform_remote_state.eks](https://www.terraform.io/language/state/remote-state-data)|data source|

# Inputs

|Name|Description|Type|Default|Required|
|----|-----------|----|-------|--------|
|dockerhub_username|Docker Hub registry username used to login and be able to pull the Bitbucket image|`string`|`null`|yes|
|dockerhub_password|Docker Hub registry password used to login and be able to pull the Bitbucket image|`string`|`null`|yes|
|domain|Domain name|`string`|`ps-dou.com`|yes|
|environment|Environment where the app will be deployed|`string`|`stg`|yes|
|bitbucket_version|Bitbucket version to deploy|`string`|`5.16.3`|yes|

# Outputs

|Name|Description|
|----|-----------|
|load_balancer_hostname|The hostname of the load balancer autogenerated by Kubernetes and AWS|
|url|The URL of the load balancer, where the app instance can be accessed|

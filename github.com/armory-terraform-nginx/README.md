# armory-terraform-bitbucket

Terraform scripts to deploy a **NGINX** intance into EKS and expose it through AWS ELB, it mounts by default Kubernetes Accounts for into Armory Spinnaker External-Accounts plugin on http configuration mode, the Kubernetes accounts can be found in this endpoint: `https://nginx.stg.ps-dou.com/accounts/kube.yaml`.

# Terraform Cloud

The remote state backend is configured to run over [armory-nginx](https://app.terraform.io/app/dou-armory/workspaces/armory-nginx) workspace in PS DOU Terraform Cloud (TFC) account.

The main `dockerhub_username` and `dockerhub_password` variables with sensitive data are already configured in current TFC [variables workspace](https://app.terraform.io/app/dou-armory/workspaces/armory-nginx/variables).

# GitHub Workflow

The GitHub repository has configured a workflow to execute a new `terraform plan` on each PR to `master` branch and validate mergeability; once the PR gets merged into `master` a `terraform apply` is auto-approved.

# Requirements

|Name      |Version     |
|----------|------------|
|terraform |>= v1.1.2   |
|aws       |~> 3.60.0   |
|kubernetes|>= 2.5.0    |

# Providers

|Name      |Version     |
|----------|------------|
|aws       |~> 3.60.0   |
|kubernetes|>= 2.5.0    |

# Resources

|Name|Type|
|-|-|
|[aws_route53_record.nginx](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record)|resource|
|[kubernetes_config_map.nginx](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/config_map)|resource|
|[kubernetes_config_map.spinnaker_kube_accounts](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/config_map)|resource|
|[kubernetes_deployment.nginx](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/deployment)|resource|
|[kubernetes_namespace.nginx](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/namespace)|resource|
|[kubernetes_secret.dockerhub](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/secret)|resource|
|[kubernetes_service.nginx](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/service)|resource|
|[aws_acm_certificate.cert](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/acm_certificate)|data source|
|[aws_elb.nginx](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elb)|data source|
|[aws_eks_cluster.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster)|data source|
|[aws_eks_cluster_auth.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/eks_cluster_auth)|data source|
|[aws_route53_zone.subdomain](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone)|data source|
|[terraform_remote_state.eks](https://www.terraform.io/language/state/remote-state-data)|data source|

# Inputs

|Name|Description|Type|Default|Required|
|----|-----------|----|-------|--------|
|dockerhub_username|Docker Hub registry username used to login and be able to pull the NGINX image|`string`|`null`|yes|
|dockerhub_password|Docker Hub registry password used to login and be able to pull the NGINX image|`string`|`null`|yes|
|domain|Domain name|`string`|`ps-dou.com`|yes|
|environment|Environment where the app will be deployed|`string`|`stg`|yes|

# Outputs

|Name|Description|
|----|-----------|
|load_balancer_hostname|The hostname of the load balancer autogenerated by Kubernetes and AWS|
|url|The URL of the load balancer, where the app instance can be accessed|
